name: Process Issue Closed

on:
  issues:
    types:
      - closed

permissions:
  contents: write
  id-token: write
  issues: write
  pull-requests: write

jobs:
  cancel:
    name: (Issue Closed) Cancel Reservation
    runs-on: ubuntu-latest

    # This job should only be run when the following conditions are true:
    #
    # - The issue has the `reservation` label.
    #
    # Since the request is being cancelled, we don't need to check if it is
    # valid. It can just be closed.
    if: |
      contains(github.event.issue.labels.*.name, 'reservation') == true

    steps:
      # NOTE: The `actions/checkout` step is not included here. This is because
      #       we don't need any scripts or resources from this repository in
      #       order to process a closed issue.

      # GitHub App authentication is required if you want to interact with any
      # resources outside the scope of the repository this workflow runs in.
      - name: Get GitHub App Token
        id: token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ vars.ISSUEOPS_APP_ID }}
          private-key: ${{ secrets.ISSUEOPS_APP_PRIVATE_KEY }}
          owner: ${{ github.repository_owner }}

      # Process the cancellation request.
      - name: Process Reservation Request
        id: process
        # When using custom actions, make sure to pin the version to a specific
        # commit or release tag!
        uses: issue-ops/demo-reservation-action@main
        with:
          action: cancel
          github_token: ${{ steps.token.outputs.token }}
          project_number: 3
